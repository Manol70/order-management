
<?php
    require_once "check_session.php";
    require_once "Bootstrap/core.html" ?>
    <div class ="container-fluid" >
<?php
require_once "title.php" 
?>

<div class="row">
<div class="col-sm-10 text-center">
<h2>ТЕСТОВ СОФТУЕР</h2>
</div>
    <div class="col-sm-2 text-center" >
<a href="logout.php">ИЗХОД</a><br/>
<a href="add_customer.php">Нов клиент</a><br/>
<a href="add_order.php?add">Нова поръчка</a><br/>
<a href="customers.php">Всички клиенти</a><br/>

<a href="references.php">АДМИН</a>

    </div>
</div>
    <div class="row">
        <div class="col-sm-2">
    <?php if(isset($_POST['select'])){
        $postData=[];
        $postData[]=$_POST;
    }
    ?>
<form method="post">
    <p>Вид монтаж:
    <select name="montage" >
        <option name="allMontage">всички</option>
        <?php foreach ($data['montage'] as $value){ ?>
            <option value="<?=$value['id']?>"
            <?php if($value['id']=='3'){ ?>
                selected <?php } ?> ><?=$value['name']?></option>
        <?php } ?>
    </select>
    </p>
    </div>
        <div class="col-sm-3">
            <p>Клиент:
    <select name="customer">
        <option name="allCustomer">всички</option>
       <?php foreach ($data['customer'] as $value): ?>
        <option value="<?= $value['id']?>" > <?= $value['name'] ?> </option>
       <?php endforeach; ?>
    </select></p>
        </div>
    <div class="col-sm-2">
    <p>Тип:
    <select name="type">
        <option name="allType">всички</option>
        <?php foreach ($data['type'] as $value): ?>
        <option value="<?=$value['id']?>"> <?=$value['name']?> </option>
        <?php endforeach; ?>
    </select>
    </p>
    </div>
        <div class="col-sm-2">
            <p>
                Стъклопакет:
                <select name="glassStatus">
                    <option name="allGlassStatuses">всички</option>
                    <?php foreach ($data['glassStatuses'] as $key=>$value) : ?>
                    <option value="<?=$key ?>"> <?=$value?> </option>
                    <?php endforeach; ?>
                </select>
            </p>
        </div>
        <div class="col-sm-2">
            <p>
                Статус:
                <select name="status">
                    <option name="allStatuses">всички</option>
                    <?php foreach ($data['statuses'] as $key=>$value):?>
                    <option value="<?=$key?>"> <?=$value?> </option>
                    <?php endforeach; ?>
                </select>
            </p>
        </div>
    </div>
    <div class="row well well-lg" style="height: 35px; padding: 5px" >
        <div class="col-sm-2" >
            <p> СОРТИРАЙ ПО:</p>
        </div>
    <div class="col-sm-2 text-left" >
        <p>
    <input type="radio" name="date" value="start_order" checked> кога е поръчана
        </p>
        </div>
            <div class="col-sm-2">
                <p> <input type="radio" name="date" value="end_order" >кога трябва да е готова </p>
            </div>
            <div class="col-sm-2">
                <p> <input type="radio" name="paid" value="paid">само неплатени</p>
            </div>
        </div>
    <div class="row" >
        <div class="col-sm-6">
            <?php require_once 'Bootstrap/calendar/index.html';
    //require_once 'calendarFromTo.php';?>
    <input type="hidden" name="order_id" value="">
    <input type="submit" name="select" value="виж">
</form>
        </div>
    </div>
 
    <?php
    if(!empty($errors)){
        foreach ($errors as $error){ ?>
    <p style="color: red"><?=$error ?> </p>
      <?php  }
      exit;
    }
    ?>
<?php if(isset($_POST['select']) or isset($_SESSION['id'])){
    if(isset($_POST['status']) and $_POST['status']=='всички' and $_POST['glassStatus']!='всички') { ?>
        <form method="post" action="edit_order.php?id=null">
        <?php
    }
    if(isset($_POST['status']) and $_POST['status']!='всички' and $_POST['glassStatus']=='всички'){ ?>
   <form method="post" action="edit_order.php?id=null">
    <?php
    }
    ?>

    <div class="table-responsive">
    <table class="table table-striped table-bordered table-col-sm-pull-12" >
    <thead >
    <tr style="background-color: #9d9d9d; font-size:90%" >
        <th style="text-align: center;">№</th>
        <th style="text-align: center;">клиент</th>
        <th style="text-align: center;">произв. схема</th>
        <th style="text-align: center;">монтаж</th>
        <th style="text-align: center;">тип</th>
        <th style="text-align: center;">м2</th>
        <th style="text-align: center;">от дата</th>
        <th style="text-align: center;">за дата</th>
        <th style="text-align: center;">сума</th>
        <th style="text-align: center;">платено</th>
        <th style="text-align: center;">остатък</th>
        <th style="text-align: center;">плащане</th>
        <th style="text-align: center;">стъклопакет</th>
        <th style="text-align: center;">статус</th>
        <th style="text-align: center;">съобщение до клиента</th>
        <th style="text-align: center;">забележка</th>
        <th></th>
    </tr>
    </thead>
    <tbody style="font-size:12px;" >
    <?php 
    /**
     * @var $value \MyOrders\DTO\OrderDTO
     */
    $all_rows=0;
    foreach ($data['orders'] as $value){ 
        $all_rows++;
    if($value->getPrice()-$value->getPaid()==0 AND isset($_POST['paid'])){
        continue;
        }
    ?>
        <tr>

   <th><a href="references.php?id=<?=$value->getId()?>&number=<?=$value->getNumber()?>&typeMontage=<?=$value->getTypeMontageName()?>">

                 <?= $value->getNumber() ?></a> </th>
            <th>
                <form method="post" action="references.php">
                    <?php if(!isset($_POST['from_date']) AND !isset($_POST['to_date'])){
                        $_POST['from_date']='';
                        $_POST['to_date']=''; }?>
                    <input type="hidden" name="from_date" value="<?=$_POST['from_date']?>">
                    <input type="hidden" name="to_date" value="<?=$_POST['to_date']?>">
                    <input type="submit" name="customer" value="<?= $value->getCustomerName()?>">
                </form>
            </th>

            <th> <?php if($value->getScheme()==null){?>

                    <a href="upload.php?id=<?=$value->getId()?>&number=<?=$value->getNumber()?>">добави схема</a>
                <?php }else{ ?>

                    <script>
                        var a ="<?=$value->getId()?>";
                    </script>
                <?php $id=$value->getId(); ?>
                    <a href="<?=$value->getScheme()?>"
                       onclick="javascript:void window.open('<?=$value->getScheme()?>',
                               '1517921651999','width=1000%,height=600%,' +
                               'toolbar=0,menubar=0,location=0,status=1,' +
                               'scrollbars=1,resizable=1,left=0,top=0');
                               return false;">Виж схема</a>

                <?php } ?>
            </th>
            <th> <?= $value->getTypeMontageName() ?> </th>
            <th style="text-align: center;"> <?= $value->getTypeName() ?> </th>
            <th style="text-align: center;"> <?= $value->getQuadrature() ?> </t>
            <th> <?= $value->getByDate() ?> </th>
            <th> <?= $value->getForDateFormatShow() ?> </th>
            <th style="text-align: center;"> <?= $value->getPrice() ?> </th>
            <th style="text-align: center;"> <?= $value->getPaid() ?> </th>
            <?php $color='';
            if($value->getPrice()-$value->getPaid()==0){
                $color='#b2dba1';
            }else{
                $color='#ff4d4d';
            }
            ?>
            <th style="text-align: center; background-color: <?=$color?>"> <?= $value->getPrice()-$value->getPaid() ?></th>
            <th style="text-align: center;">
                <form method="post" action="paid.php">
                    <button type="submit" name="<?=$value->getId() ?>"  value="плащане" style="font-size:14px"><i class="fa fa-dollar"></i></button>
                </form>
            </th>
            <?php $color='';?>
            <?php if($value->getGlass()=='доставен'){
                $color='#b2dba1';
            }
            if($value->getGlass()=='Поръчан'){
                $color='#ffff80';
            }
            ?>
            <th style="background-color: <?=$color ?>"> <?= $value->getGlass() ?> <br/>
                <?php $nameNewGlass=$value->getNewGlass();
                if(isset($_POST['status']) and $_POST['glassStatus']!='всички' and $value->getGlass()!=='доставен'){ ?>
                    <label><input type="checkbox" value="<?=$value->getId() ?>" name="id[]"> промени</label>
                    <br><br/>
                    <?php
                }
                if ($nameNewGlass!=null and $_POST['glassStatus']=='всички') {
                    $nameNewGlass .="-".$value->getId();
                 require 'Bootstrap/modalGlass.php';
                }
                ?>
            </th>
            <?php $color='';?>
            <?php if($value->getStatusName()=='взета'){
                $color='#b2dba1';
            } 
            if($value->getStatusName()=='производство'){
                $color='#ffff80';
            }
            if($value->getStatusName()=='готова'){
                $color='#ffa64d';
            }
                            ?>
            <th style="background-color: <?=$color ?>"> <?= $value->getStatusName() ?>
                <?php $name=$value->getNewStatus();
               if(isset($_POST['status']) and $_POST['status']!='всички' and $value->getStatusName()!=='взета'){ ?>
                    <label><input type="checkbox" value="<?=$value->getId() ?>" name="id[]"> промени</label>

                    <br><br/>
                    <?php
                    }
                if ($name!=null and $_POST['status']=='всички') {
                    $name .= "-" . $value->getId() ?>
                    <?php require 'Bootstrap/modalStatus.php';
                } ?>
            </th>
            <?php $color='';
            if($value->getStatusMail()=='1'){
                $color='#b2dba1';
            }
            ?>

            <th style="text-align: center; background-color: <?=$color ?>">
                <?php
                if($value->getStatusMail()==0){ ?>
                <form method="post" action="send_mail.php">
                    <input type="hidden" name="order_id" value="<?=$value->getId()?>">
                    <input type="hidden" name="customer_name" value="<?=$value->getCustomerName()?>" >
                    <input type="hidden" name="type" value="<?=$value->getTypeName()?>">
                    <button type="submit" name="mail" value="изпрати" style="font-size:14px"><i class="fa fa-envelope-o"></i></button>
                   <!-- <input type="submit" name="mail" value="изпрати">-->
                </form>
                <?php
                }else{ ?>
                <p>изпратено</p>
                <?php } ?>
            </th>

            <th> <?= $value->getNote() ?> </th>


            <th>
                <a href="edit_order.php?id=<?=$value->getId()?>&number=<?=$value->getNumber()?>">edit</a>

            </th>
        </tr>

<?php }?>
    <tr>
        <th colspan="3" class="text-center">БРОЙ ПОРЪЧКИ: <?php echo $all_rows ?></th>
        <th colspan="" class="text-right">ОБЩO:</th>
        <th><?=$data['sumColumn']['quadrature']?></th>
        <th colspan="2"></th>
        <th><?=$data['sumColumn']['price']?></th>
        <th><?=$data['sumColumn']['paid']?></th>
        <th><?=$data['sumColumn']['price']-$data['sumColumn']['paid']?></th>
         <?php
        if(isset($_POST['status']) and $_POST['glassStatus']!='всички'){ ?>
        <th></th>
        <th>
            <label><input type="hidden" value="<?=$nameNewGlass ?>" name="glassStatusName"></label>
            <input type="submit" value="промени" name="someGlassStatuses">
    </form>
        </th>
        <th>
        </th>
        <th colspan="3"></th>
        <?php
        }elseif (isset($_POST['status']) and $_POST['status']!='всички') { ?>
        <th></th>
        <th>
        </th>
        <th>
            <label><input type="hidden" value="<?= $name ?>" name="statusName"></label>
            <input type="submit" value="промени" name="someStatuses">
        </form>
        </th>
        <th colspan="3"></th>
        <?php
    }else { ?>
    <th colspan="6"></th>
    <?php
    }
    ?>

    </tr>
    </tbody>
</table>
    <?php } ?>
</div>
</div>
